<!DOCTYPE html>
<html>
<head>
  <title>Monocular AI Drone</title>
  <style>
    body { 
      margin: 0; 
      background-color: #282C34;
      font-family: Arial, sans-serif; 
      color: #FFF; 
      position: relative;
      height: 100vh;
    }

    #controls {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.5);
      padding: 10px;
      border-radius: 5px;
      width: 200px;
    }
    #controls h2 {
      margin: 0 0 10px 0;
      font-size: 16px;
      font-weight: bold;
      text-decoration: underline;
    }
    #controls p {
      margin: 5px 0;
      font-size: 14px;
    }
    #speed, #position, #camera-position {
      margin-top: 10px;
      font-size: 14px;
    }
    #pitch-info, #yaw-info, #roll-info {
      margin-top: 6px;
      font-size: 14px;
    }

    /* Main control panel on the left */
    #websocket-controls {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 5px;
      max-width: 300px;
      border: 2px dashed #A40808;
    }
    #websocket-controls h2 {
      margin: 0;
      margin-bottom: 10px;
      font-size: 16px;
      font-weight: bold;
      text-decoration: underline;
    }
    #websocket-controls button {
      width: 100%;
      padding: 6px;
      background: #A40808;
      border: none;
      border-radius: 3px;
      color: #FFF;
      cursor: pointer;
      font-weight: bold;
      margin-top: 5px;
    }
    #websocket-controls button:hover {
      background: #C51919;
    }
    #goalInput {
      width: 96%;
      padding: 6px;
      margin-top: 5px;
      border-radius: 3px;
      border: none;
    }
    #bboxDisplay {
      font-weight: bold;
      color: #FFD700;
    }

    /* Plan & Steps box */
    #plan-steps-container {
      position: absolute;
      bottom: 20px;
      right: 360px; 
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 5px;
      max-width: 300px;
      border: 2px dashed #048A17;
    }
    #plan-steps-container h2 {
      margin: 0;
      margin-bottom: 10px;
      font-size: 16px;
      font-weight: bold;
      text-decoration: underline;
    }
    #planList {
      margin: 0;
      padding-left: 20px;
      font-size: 14px;
    }
    .completed-step {
      text-decoration: line-through;
      color: #AAA;
    }

    /* History box */
    #history-container {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 5px;
      max-width: 300px;
      border: 2px dashed #808080;
    }
    #history-container h2 {
      margin: 0;
      margin-bottom: 10px;
      font-size: 16px;
      font-weight: bold;
      text-decoration: underline;
    }
    #historyContent {
      white-space: pre-wrap;
      max-height: 180px;
      overflow-y: auto;
      font-size: 14px;
      background-color: rgba(255,255,255,0.05);
      padding: 5px;
      border-radius: 5px;
    }

    /* Loading Spinner */
    #spinner {
      display: none; /* hidden by default */
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
      width: 64px;
      height: 64px;
      border: 8px solid rgba(255,255,255,0.2);
      border-top: 8px solid #FFF;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Spinner element (hidden by default) -->
  <div id="spinner"></div>

  <div id="controls">
    <h2>Controls</h2>
    <p>W/S: Increase/Decrease Throttle</p>
    <p>A/D: Yaw Left/Right</p>
    <p>I/K: Pitch Forward/Backward</p>
    <p>J/L: Roll Left/Right</p>
    <p>C: Toggle Drone (3rd person) View</p>
    <p>M: Toggle Bottom View</p>

    <p id="speed">Speed: 0</p>
    <p id="position">Position: (0, 0, 0)</p>
    <p id="camera-position">Camera Position: (0, 0, 0)</p>

    <p id="pitch-info">Pitch: 0</p>
    <p id="yaw-info">Yaw: 0</p>
    <p id="roll-info">Roll: 0</p>
  </div>

  <div id="websocket-controls">
    <h2>AI Pilot</h2>

    <!-- Retrieve plan from /get_plan -->
    <button id="retrievePlanBtn">Retrieve Plan</button>
    <label for="goalInput">Goal for Plan:</label>
    <input type="text" id="goalInput" value="Explore the city" />

    <!-- Open WebSocket to /feed -->
    <button id="openWsBtn">Open WebSocket</button>

    <!-- We'll send the current step as the "goal" in a JSON message (with optional frame) -->
    <button id="sendStepBtn">Send Current Step to WS</button>

    <!-- Send the current frame (and same or different goal) to WS -->
    <button id="sendFrameBtn">Send Frame (WS)</button>

    <!-- Mark the current step as complete locally (for UI) -->
    <button id="nextStepBtn">Complete Current Step</button>

    <p>Bounding Box: <span id="bboxDisplay">N/A</span></p>
  </div>

  <div id="plan-steps-container">
    <h2>Plan</h2>
    <ol id="planList"></ol>
  </div>

  <div id="history-container">
    <h2>History</h2>
    <div id="historyContent">No history yet.</div>
  </div>

  <!-- Drone-related scripts (assume your simulation code) -->
  <script src="https://threejs.org/build/three.js"></script>
  <script type="module" src="drone.js"></script>

  <script>
    let ws = null;
    let planSteps = [];
    let currentStepIndex = 0;
    let globalHistory = [];  // Now just an array of strings
    let currentGoalText = ""; 

    // Helper function to show/hide the spinner
    function showSpinner() {
      document.getElementById('spinner').style.display = 'block';
    }
    function hideSpinner() {
      document.getElementById('spinner').style.display = 'none';
    }

    // Helper function to convert a Blob to base64
    async function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const dataUrl = reader.result;
          const base64 = dataUrl.split(",")[1];
          resolve(base64);
        };
        reader.onerror = (err) => reject(err);
        reader.readAsDataURL(blob);
      });
    }

    // Render plan steps with strike-out for completed steps
    function renderPlanSteps() {
      const planList = document.getElementById('planList');
      planList.innerHTML = '';

      planSteps.forEach((stepObj, idx) => {
        const li = document.createElement('li');
        li.textContent = stepObj.step_description || "No step description";
        if (idx < currentStepIndex) {
          li.classList.add('completed-step');
        }
        planList.appendChild(li);
      });
    }

    /**
     * Display history in #historyContent as a numbered list of vantage strings.
     */
    function updateHistoryDisplay(historyData) {
      const container = document.getElementById("historyContent");
      container.innerHTML = ""; // clear old content

      if (!Array.isArray(historyData) || historyData.length === 0) {
        container.textContent = "No history yet.";
        return;
      }

      const ol = document.createElement("ol");
      historyData.forEach((entry) => {
        const li = document.createElement("li");
        // Each "entry" is just a string now
        li.textContent = entry;
        ol.appendChild(li);
      });
      container.appendChild(ol);
    }

    // 1. Retrieve the plan from /get_plan (remains the same)
    document.getElementById('retrievePlanBtn').onclick = async () => {
      const goal = document.getElementById('goalInput').value.trim();
      if (!goal) {
        alert("Please enter a goal first.");
        return;
      }

      showSpinner(); // Show the loading spinner

      let base64Image = null;
      if (window.lastDroneBlob) {
        base64Image = await blobToBase64(window.lastDroneBlob);
      }

      // Build the request body for /get_plan
      const requestBodyForPlan = {
        goal: goal
      };
      // Optionally add re-eval context
      if (globalHistory && globalHistory.length > 0) {
        requestBodyForPlan.history = globalHistory;
      }
      if (planSteps.length > 0) {
        requestBodyForPlan.previousPlan = planSteps;
      }
      if (base64Image) {
        requestBodyForPlan.image = base64Image;
      }

      try {
        const responsePlan = await fetch('/get_plan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBodyForPlan)
        });
        const dataPlan = await responsePlan.json();

        if (dataPlan.planSteps) {
          planSteps = dataPlan.planSteps;
          currentStepIndex = 0;
          renderPlanSteps();
        } else {
          console.warn("No planSteps in /get_plan response:", dataPlan);
        }
      } catch (err) {
        console.error("Error calling /get_plan:", err);
      } finally {
        hideSpinner();
      }
    };

    // 2. Open the WebSocket
    document.getElementById('openWsBtn').onclick = () => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        console.warn("WebSocket is already open.");
        return;
      }
      ws = new WebSocket("ws://localhost:8000/feed");

      ws.onopen = () => {
        console.log("WebSocket opened successfully.");
      };
      ws.onerror = (err) => {
        console.error("WebSocket Error:", err);
      };
      ws.onclose = () => {
        console.log("WebSocket closed.");
      };

      ws.onmessage = (event) => {
        console.log("WS Message:", event.data);
        try {
          const parsed = JSON.parse(event.data);
          switch (parsed.type) {
            case "bounding_box":
              // Hide spinner when bounding_box arrives
              hideSpinner();
              // Show the bounding box
              document.getElementById('bboxDisplay').textContent =
                `[${parsed.data.join(", ")}]`;
              break;

            case "history":
              // Update local history array
              globalHistory = parsed.data;
              updateHistoryDisplay(globalHistory);
              break;

            case "error":
              // The server might send an "error" type
              hideSpinner();
              console.error("Server error:", parsed.message);
              alert("Server error: " + parsed.message);
              break;

            default:
              console.log("Unrecognized WS message type:", parsed.type);
              break;
          }
        } catch (e) {
          console.error("Error parsing WS message:", e);
        }
      };
    };

    // 3. Send the CURRENT step to the WebSocket
    document.getElementById('sendStepBtn').onclick = async () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        console.warn("WebSocket is not open.");
        return;
      }
      if (planSteps.length === 0) {
        alert("No plan steps to send. Retrieve a plan first.");
        return;
      }

      // The current step’s "goal" text
      currentGoalText = planSteps[currentStepIndex]
        ? planSteps[currentStepIndex].step_description
        : "(No step found)";

      // Optionally attach the current frame
      let base64Image = null;
      if (window.lastDroneBlob) {
        base64Image = await blobToBase64(window.lastDroneBlob);
      }

      showSpinner();
      // Send a JSON message with {goal, history, image}
      ws.send(JSON.stringify({
        goal: currentGoalText,
        history: globalHistory || [],
        image: base64Image
      }));

      console.log("Sent step as goal + optional image to WS:", currentGoalText);
    };

    // 4. Send a frame to the WS (for bounding box / history update)
    document.getElementById('sendFrameBtn').onclick = async () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        console.warn("WebSocket is not open. Cannot send frame.");
        return;
      }
      if (!window.lastDroneBlob) {
        console.warn("No drone FPV frame available to send yet.");
        return;
      }

      showSpinner(); // We'll hide it once bounding_box is received

      // Convert the blob to base64
      const base64Image = await blobToBase64(window.lastDroneBlob);

      // We can pass the same or a different "goal" here
      const goal = document.getElementById('goalInput').value.trim() || "N/A";

      // Send JSON with { goal, history, image } 
      ws.send(JSON.stringify({
        goal: goal,
        history: globalHistory,
        image: base64Image
      }));

      console.log("Sent drone FPV frame + current history to WS.");
    };

    // 5. Complete the current step => increment step index (local UI only)
    document.getElementById('nextStepBtn').onclick = () => {
      if (currentStepIndex < planSteps.length) {
        currentStepIndex += 1;
        renderPlanSteps();
      }
    };
  </script>
</body>
</html>
