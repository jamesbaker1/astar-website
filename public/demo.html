<!DOCTYPE html>
<html>
<head>
  <title>Drone Gemini Demo</title>
  <style>
    body { 
      margin: 0; 
      background-color: #282C34;
      font-family: Arial, sans-serif; 
      color: #FFF; 
    }

    #controls {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.5);
      padding: 10px;
      border-radius: 5px;
      width: 200px;
    }
    #controls h2 {
      margin: 0 0 10px 0;
      font-size: 16px;
      font-weight: bold;
      text-decoration: underline;
    }
    #controls p {
      margin: 5px 0;
      font-size: 14px;
    }
    #speed, #position, #camera-position {
      margin-top: 10px;
      font-size: 14px;
    }
    /* NEW: Add some margin for the pitch, yaw, roll indicators */
    #pitch-info, #yaw-info, #roll-info {
      margin-top: 6px;
      font-size: 14px;
    }

    #websocket-controls {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 5px;
      max-width: 300px;
      border: 2px dashed #A40808;
    }
    #websocket-controls h2 {
      margin: 0;
      margin-bottom: 10px;
      font-size: 16px;
      font-weight: bold;
      text-decoration: underline;
    }
    #websocket-controls button {
      width: 100%;
      padding: 6px;
      background: #A40808;
      border: none;
      border-radius: 3px;
      color: #FFF;
      cursor: pointer;
      font-weight: bold;
      margin-top: 5px;
    }
    #websocket-controls button:hover {
      background: #C51919;
    }
    #goalInput {
      width: 100%;
      padding: 6px;
      margin-top: 5px;
      border-radius: 3px;
      border: none;
    }
    #bboxDisplay {
      font-weight: bold;
      color: #FFD700;
    }
  </style>
</head>
<body>
  <!-- Drone Flight Controls -->
  <div id="controls">
    <h2>Controls</h2>
    <p>W/S: Increase/Decrease Throttle</p>
    <p>A/D: Yaw Left/Right</p>
    <p>I/K: Pitch Forward/Backward</p>
    <p>J/L: Roll Left/Right</p>
    <p>C: Toggle Drone (3rd person) View</p>
    <p>M: Toggle Bottom View</p>

    <p id="speed">Speed: 0</p>
    <p id="position">Position: (0, 0, 0)</p>
    <p id="camera-position">Camera Position: (0, 0, 0)</p>

    <!-- NEW: Realtime pitch, yaw, roll info -->
    <p id="pitch-info">Pitch: 0</p>
    <p id="yaw-info">Yaw: 0</p>
    <p id="roll-info">Roll: 0</p>
  </div>

  <!-- WebSocket / Goal Controls -->
  <div id="websocket-controls">
    <h2>AI Pilot</h2>
    <button id="updateGoalBtn">Update Goal</button>
    <button id="sendFrameBtn">Send Frame</button>

    <label for="goalInput">Current Goal:</label>
    <input type="text" id="goalInput" value="go into the next room" />

    <p>Bounding Box: <span id="bboxDisplay">N/A</span></p>
  </div>

  <!-- For your three.js or other main script(s) -->
  <script src="https://threejs.org/build/three.js"></script>
  <script type="module" src="drone.js"></script>

  <script>
    let ws;

    // --------------------------------------------------------------------------------------
    // NEW: AI Pilot target info (for bounding-box-based movement)
    // --------------------------------------------------------------------------------------
    // Example: index.html or somewhere global
    window.aiPilotTarget = {
      isActive: false,
      distanceToTravel: 0,   // how many meters to move forward
      yawGoal: 0,
      pitchGoal: 0,
      doneTurning: false,
    };

    // Connect WebSocket automatically on page load
    window.addEventListener('load', () => {
      ws = new WebSocket("ws://localhost:8000/feed");
      ws.onopen = () => {
        console.log("WebSocket open");
        // Send initial goal automatically
        const initialGoal = { goal: document.getElementById('goalInput').value };
        ws.send(JSON.stringify(initialGoal));
      };
      ws.onerror = (err) => console.error("WebSocket Error:", err);
      ws.onclose = () => console.log("WebSocket closed");
      ws.onmessage = (event) => {
        console.log("Message from server:", event.data);
        try {
          const data = JSON.parse(event.data);
          if (data.bounding_box) {
            document.getElementById('bboxDisplay').textContent =
              `[${data.bounding_box.join(", ")}]`;
            console.log("Received bounding box:", data.bounding_box);

            // ------------------------------------------------------------------------
            // NEW: Convert the Gemini bounding box to our 320x240 coordinate space
            // Gemini returns in [ymin, xmin, ymax, xmax] scaled to 1000x1000
            // So we do: (value / 1000) * [FPV_width or FPV_height]
            // Then store in window.aiPilotTarget to move the drone
            // ------------------------------------------------------------------------
            const [ymin, xmin, ymax, xmax] = data.bounding_box;
            const xC = ((xmin + xmax) / 2) / 1000 * 320; 
            const yC = ((ymin + ymax) / 2) / 1000 * 240; 
            console.log("xC", xC, "yC", yC);

            // We want to figure out how far off-center it is
            const diffX = xC - 160;   // negative if left of center
            const diffY = yC - 120;   // negative if above center

            // Suppose each pixel of x-difference = 0.002 radians of yaw (tweak as needed)
            // Suppose each pixel of y-difference = 0.002 radians of pitch
            // Usually you'd invert Y if needed, e.g. pitch = - diffY * factor
            const factor = 0.002; 
            const yawNeeded = -diffX * factor;   
            const pitchNeeded = diffY * factor;  

            // "Initial" yaw/pitch come from your current global variables
            // (assuming you store them in `yaw`, `pitch` in drone.js)
            // So your final goal is:
            window.aiPilotTarget.yawGoal   = yaw + yawNeeded;
            window.aiPilotTarget.pitchGoal = pitch + pitchNeeded;
            window.aiPilotTarget.doneTurning = false;
            window.aiPilotTarget.distanceToTravel = 5;  // move 5 meters after turning
            window.aiPilotTarget.isActive = true;
          }
        } catch (e) {
          console.error("Error parsing JSON:", e);
        }
      };
    });

    // Update the goal (send text) only
    document.getElementById('updateGoalBtn').onclick = () => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        const newGoal = { goal: document.getElementById('goalInput').value };
        ws.send(JSON.stringify(newGoal));
      } else {
        console.warn("WebSocket is not open. Cannot update goal.");
      }
    };

    // Send the latest drone FPV to request bounding box or inference
    document.getElementById('sendFrameBtn').onclick = async () => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        if (window.lastDroneBlob) {
          // Convert the most recent drone FPV to an ArrayBuffer and send
          const arrayBuffer = await window.lastDroneBlob.arrayBuffer();
          ws.send(arrayBuffer);
          console.log("Sent the latest drone FPV frame.");
        } else {
          console.warn("No drone FPV frame available to send yet.");
        }
      } else {
        console.warn("WebSocket is not open. Cannot send frame.");
      }
    };
  </script>
</body>
</html>
